<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Readact</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered!', reg))
                    .catch(err => console.log('Service Worker failed:', err));
            });
        }
    </script>

    <style>
        /* --- THEME --- */
        :root { 
            --primary: #000000; 
            --secondary: #1a1a1a;
            --accent: #ffffff; 
            --red-accent: #ff3333; 
            --bg: #000000; 
            --text: #e0e0e0;
            --panel-bg: rgba(20, 20, 20, 0.95);
            --border: #444444;
            --shadow: 0 8px 32px rgba(0,0,0,0.8);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            height: 100vh; 
            background: var(--bg); 
            color: var(--text); 
            overflow: hidden; 
            overscroll-behavior: none;
        }

        /* --- FLOATING PILLS --- */
        .float-pill {
            position: fixed;
            z-index: 100;
            display: flex;
            align-items: center;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 50px; 
            padding: 5px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(8px);
            gap: 5px;
            transition: all 0.2s ease;
        }

        /* --- BUTTONS --- */
        /* Icon only buttons */
        .icon-btn {
            background: transparent; border: none; color: var(--text);
            width: 40px; height: 40px; border-radius: 50%; 
            font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s ease;
            flex-shrink: 0;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }
        .icon-btn:active { transform: scale(0.95); }
        .icon-btn.active { background: var(--accent); color: black; }
        .icon-btn.lock-btn.active { background: var(--red-accent); color: white; }
        .icon-btn:disabled { opacity: 0.3; cursor: default; }

        /* Specific smaller size for Zoom buttons on Desktop */
        .zoom-btn { width: 32px; height: 32px; font-size: 1rem; }

        /* Text/Pill Buttons (Mode Toggle) */
        .pill-btn {
            background: transparent; border: none; color: #888; 
            padding: 8px 16px; border-radius: 25px; cursor: pointer; 
            font-weight: 700; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.2s ease;
            height: 40px;
            min-width: 80px;
        }
        .pill-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .pill-btn:active { transform: scale(0.96); }
        .pill-btn.active { background: var(--accent); color: black; }

        /* Separators */
        .sep { width: 1px; height: 20px; background: #444; margin: 0 2px; }

        /* --- LOCATIONS & SPACING --- */
        
        /* Top Left */
        #ui-menu { top: 20px; left: 20px; }
        
        /* Top Center */
        #ui-mode { 
            top: 20px; left: 50%; transform: translateX(-50%); 
            padding: 5px; gap: 0;
        }
        
        /* RIGHT SIDE STACK */
        #ui-history { 
            top: 20px; right: 20px; 
            display: none; 
            gap: 5px;
        }
        
        #ui-tools { 
            top: 90px; right: 20px; 
            display: none; 
            flex-direction: row;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            padding: 5px; 
        }

        #ui-text-props {
            position: fixed; 
            top: 160px; right: 20px; 
            width: 220px;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 15px;
            box-shadow: var(--shadow);
            display: none; 
            flex-direction: column;
            gap: 12px;
            z-index: 90;
        }

        #ui-zoom { bottom: 30px; left: 50%; transform: translateX(-50%); padding: 5px 15px; gap: 10px; }
        #zoom-disp { font-family: monospace; font-size: 0.9rem; color: #aaa; width: 40px; text-align: center; }

        /* Min/Max Button */
        #tools-toggle { 
            display: none; 
            width: 28px; height: 28px; 
            border-radius: 50%;
            background: #333;
            color: white; 
            align-items: center; justify-content: center;
            cursor: pointer; 
            font-size: 10px;
            margin-right: 5px;
            transition: transform 0.3s;
        }
        
        /* --- MOBILE SCALING (Max Width 600px) --- */
        @media (max-width: 600px) {
            /* Tighter spacing for containers */
            .float-pill { padding: 4px; gap: 3px; }

            /* Smaller Icons */
            .icon-btn { width: 34px; height: 34px; font-size: 1rem; }
            .zoom-btn { width: 28px; height: 28px; font-size: 0.9rem; }
            
            /* Smaller Pills */
            .pill-btn { 
                height: 34px; 
                padding: 0 12px; 
                font-size: 0.8rem; 
                min-width: 60px; 
            }

            /* Adjust Separator */
            .sep { height: 16px; margin: 0 1px; }

            /* Reposition Elements closer to edge */
            #ui-menu { top: 15px; left: 15px; }
            #ui-mode { top: 15px; }
            #ui-history { top: 15px; right: 15px; }
            
            /* Compact Tools Layout */
            #ui-tools { top: 75px; right: 15px; }
            #tools-toggle { display: flex; width: 26px; height: 26px; }
            
            /* Minimized State */
            #ui-tools.minimized { width: 36px; padding: 4px; background: rgba(20,20,20,0.6); }
            #ui-tools.minimized .icon-btn, #ui-tools.minimized .sep { display: none; }
            #ui-tools.minimized #tools-toggle { margin-right: 0; transform: rotate(180deg); background: var(--accent); color: black; }

            /* Compact Text Props */
            #ui-text-props { 
                top: 130px; right: 15px; 
                width: 180px; 
                padding: 10px;
            }
            .prop-label { font-size: 0.65rem; }
            input[type=range] { height: 3px; }
            
            #ui-zoom { bottom: 20px; padding: 4px 10px; }
        }

        /* --- TEXT PROPERTIES WIDGETS --- */
        .prop-section { display: flex; flex-direction: column; gap: 8px; }
        .prop-label { font-size: 0.7rem; color: #888; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .prop-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }

        select { 
            background: #333; color: white; border: 1px solid #555; 
            padding: 6px; border-radius: 6px; width: 100%; font-size: 0.85rem; outline: none;
        }

        .style-grp { display: flex; background: #333; border-radius: 8px; overflow: hidden; width: 100%; border: 1px solid #555; }
        .style-grp button { 
            flex: 1; background: transparent; border: none; color: #ccc; 
            padding: 8px 0; cursor: pointer; border-right: 1px solid #555;
            transition: 0.2s;
        }
        .style-grp button:last-child { border-right: none; }
        .style-grp button:hover { background: rgba(255,255,255,0.1); }
        .style-grp button.active { background: var(--accent); color: black; }

        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .swatch { 
            width: 28px; height: 28px; border-radius: 50%; border: 2px solid #333; cursor: pointer; 
            transition: transform 0.2s;
        }
        .swatch:hover { transform: scale(1.1); }
        .swatch.active { border-color: white; transform: scale(1.15); box-shadow: 0 0 8px rgba(255,255,255,0.3); }

        input[type=range] { flex: 1; accent-color: var(--red-accent); cursor: pointer; height: 4px; border-radius: 2px; }
        .slider-val { font-size: 0.8rem; color: #ccc; width: 30px; text-align: right; font-family: monospace; }

        /* --- SETTINGS MODAL --- */
        #modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 300; backdrop-filter: blur(5px);
            align-items: center; justify-content: center;
        }
        #modal-overlay.active { display: flex; }
        .modal-box {
            background: var(--secondary); border: 1px solid var(--border);
            border-radius: 12px; padding: 25px; width: 90%; max-width: 320px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .modal-header h3 { margin: 0; color: var(--accent); }
        .close-modal-btn { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; }

        /* --- LIVE TEXTAREA --- */
        .live-textarea {
            position: absolute;
            background: rgba(0,0,0,0.6); 
            border: 1px dashed rgba(255,255,255,0.5);
            padding: 0; margin: 0;
            outline: none; overflow: hidden; resize: none;
            line-height: 1.2;
            z-index: 50; white-space: pre; 
            user-select: text;
        }

        #sidebar { 
            position: fixed; top: 0; left: 0; height: 100%; width: 280px;
            background: var(--primary); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px;
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 200; box-shadow: 5px 0 20px rgba(0,0,0,0.5);
        }
        #sidebar.open { transform: translateX(0); }
        #sidebar-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 150;
        }
        #sidebar-overlay.active { display: block; }

        h2 { margin: 0 0 20px 0; font-size: 1.2rem; border-bottom: 1px solid var(--border); padding-bottom: 15px; display: flex; justify-content: space-between; align-items: center; color: var(--red-accent); }
        .close-sidebar-btn { background: none; border: none; color: var(--accent); font-size: 1.8rem; cursor: pointer; }
        .btn { display: block; width: 100%; padding: 12px; margin-bottom: 8px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; text-align: center; color: var(--text); font-size: 13px; background: #333; }
        .btn:hover { background: #444; }
        input[type="file"] { display: none; }
        #gallery-list { flex: 1; overflow-y: auto; margin-top: 15px; margin-bottom: 10px; }
        .gallery-item { padding: 10px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: #111; border: 1px solid #333; }
        .gallery-item.active { background: #222; border-color: var(--accent); }
        .gallery-item img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 10px; background: #000; }
        .gallery-item span { font-size: 0.9rem; color: #ccc; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .rename-btn { background: none; border: none; color: #666; cursor: pointer; font-size: 1.2rem; padding: 0 5px; }
        .rename-btn:hover { color: var(--accent); }

        #main { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #000; display: flex; align-items: center; justify-content: center; }
        #content-wrapper { transform-origin: center center; box-shadow: 0 0 50px rgba(0,0,0,0.5); transition: transform 0.05s linear; position: relative; } 
        canvas { display: block; background: #111; touch-action: none; }
        
        #status-msg { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 100; }
        #empty-state { text-align: center; color: #444; pointer-events: none; }
        #version-tag { margin-top: 0; padding-top: 10px; border-top: 1px solid var(--border); text-align: center; color: #555; font-size: 0.75rem; font-family: monospace; }
        #btn-settings { margin-top: auto; margin-bottom: 15px; }
        .default-mark { position: absolute; top: 45px; left: 48.4%; transform: translateX(-50%); color: #666; font-size: 10px; pointer-events: none; }
    </style>
</head>
<body>

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="modal-overlay" onclick="closeSettings(event)">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="close-modal-btn" onclick="toggleSettings()">√ó</button>
            </div>
            <div class="setting-row" style="position:relative; display:block; margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#aaa; font-size:0.9rem; font-weight:600;">
                    <span>Zoom Speed</span>
                    <span id="speed-val">150%</span>
                </div>
                <input type="range" id="zoom-slider" min="10" max="300" value="150" step="10" oninput="updateZoomSpeed(this.value)" style="width:100%">
                <div class="default-mark">‚ñ≤</div>
            </div>
        </div>
    </div>

    <div id="ui-text-props" onmousedown="event.stopPropagation()">
        <div class="prop-section">
            <div class="prop-label">Typography</div>
            <div class="prop-row">
                <select id="font-select" onchange="updateFont(this.value)">
                    <option value="sans-serif">Sans Serif</option>
                    <option value="serif">Serif</option>
                    <option value="monospace">Monospace</option>
                    <option value="cursive">Handwriting</option>
                </select>
            </div>
            <div class="prop-row">
                <input type="range" id="text-size-slider" min="10" max="200" value="30" step="5" oninput="updateTextSize(this.value)">
                <span id="text-size-val" class="slider-val">30</span>
            </div>
        </div>

        <div class="prop-section">
            <div class="prop-label">Style</div>
            <div class="style-grp">
                <button id="btn-bold" onclick="toggleStyle('bold')"><b>B</b></button>
                <button id="btn-italic" onclick="toggleStyle('italic')"><i>I</i></button>
                <button id="btn-underline" onclick="toggleStyle('underline')"><u>U</u></button>
            </div>
        </div>

        <div class="prop-section">
            <div class="prop-label">Color</div>
            <div class="color-grid" id="color-palette"></div>
        </div>
    </div>

    <div class="float-pill" id="ui-menu" onmousedown="event.preventDefault()">
        <button class="icon-btn" onclick="toggleSidebar()">‚ò∞</button>
    </div>

    <div class="float-pill" id="ui-mode">
        <button class="pill-btn" id="btn-edit" onclick="setMode('edit')">‚úèÔ∏è Edit</button>
        <button class="pill-btn active" id="btn-quiz" onclick="setMode('quiz')">üéì Quiz</button>
    </div>

    <div class="float-pill" id="ui-history" onmousedown="event.preventDefault()">
        <button class="icon-btn" id="btn-undo" onclick="undoAction()">‚Ü©</button>
        <button class="icon-btn" id="btn-redo" onclick="redoAction()">‚Ü™</button>
    </div>

    <div class="float-pill" id="ui-tools" onmousedown="event.preventDefault()">
        <div id="tools-toggle" onclick="toggleToolsMinimize()">‚ñº</div>
        <button class="icon-btn active" id="btn-tool-box" onclick="setTool('box')" title="Box Tool">‚¨ú</button>
        <button class="icon-btn" id="btn-tool-text" onclick="handleTextToolClick(event)" title="Text Tool">T</button>
        <div class="sep"></div>
        <button class="icon-btn" id="btn-redactable" onclick="toggleRedactable()" title="Toggle Redaction (Lock)">üîì</button>
    </div>

    <div class="float-pill" id="ui-zoom" onmousedown="event.preventDefault()">
        <button class="icon-btn zoom-btn" onclick="adjustZoom(-0.1)">-</button>
        <span id="zoom-disp">Fit</span>
        <button class="icon-btn zoom-btn" onclick="adjustZoom(0.1)">+</button>
    </div>

    <div id="sidebar">
        <h2>
            Readact 
            <button class="close-sidebar-btn" onclick="toggleSidebar()">√ó</button>
        </h2>
        <div>
            <label for="imgLoader" class="btn">üìÇ Add Images</label>
            <input type="file" id="imgLoader" multiple accept="image/*">
            <button class="btn" onclick="downloadData()">üíæ Download JSON</button>
            <label for="fileLoader" class="btn">üì• Load JSON</label>
            <input type="file" id="fileLoader" accept=".json,application/json">
            <button class="btn" onclick="resetAll()">üóëÔ∏è Reset All</button>
        </div>
        <div id="gallery-list"></div>
        <button class="btn" id="btn-settings" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
        <div id="version-tag">v0.0.2</div>
    </div>

    <div id="main">
        <div id="empty-state">
            <h3>No Images</h3>
            <p>Click ‚ò∞ to start</p>
        </div>
        <div id="content-wrapper">
            <canvas id="canvas" style="display:none;"></canvas>
        </div>
        <div id="status-msg">Saved</div>
    </div>

    <script>
        const DB_NAME = "ReadactDB"; 
        const STORE_NAME = "images";
        let db;

        const COLORS = ['#ffffff', '#000000', '#ff3333', '#3333ff', '#33ff33', '#ffff33', '#ff9900', '#9933ff', '#ff66b2', '#00ffff'];

        let appData = { images: [], idx: -1 };
        let imgObjects = []; 
        let mode = 'quiz';
        let activeTool = 'box'; 
        let currentScale = 1;
        let sliderValue = 150; 
        let isTextPropsOpen = false; 
        
        let textProps = {
            size: 30, font: 'sans-serif',
            bold: false, italic: false, underline: false,
            color: '#ffffff',
            redactable: false
        };

        let activeTextIndex = -1; 
        let panX=0, panY=0, startX=0, startY=0;
        let isPinching=false, lastPinchDist=0, pinchStartCenter={x:0,y:0};
        let isPanning=false, panStartX=0, panStartY=0;
        let isDragAction=false, isPointerDown=false;
        let undoStack=[], redoStack=[];

        window.onload = async () => {
            await initDB();
            initColorPalette();
            const stored = await getAllImages();
            if (stored.length > 0) {
                appData.images = stored;
                let loadedCount = 0;
                appData.images.forEach(data => {
                    const img = new Image();
                    img.onload = () => {
                        loadedCount++;
                        if(loadedCount === appData.images.length) {
                            renderGallery();
                            selectImage(0);
                        }
                    };
                    img.src = data.src;
                    imgObjects.push(img);
                });
            }
            setMode('quiz');
            if(window.innerWidth <= 600) {
                document.getElementById('ui-tools').classList.add('minimized');
            }
        };

        function initColorPalette() {
            const grid = document.getElementById('color-palette');
            grid.innerHTML = '';
            COLORS.forEach(c => {
                const d = document.createElement('div');
                d.className = 'swatch';
                d.style.backgroundColor = c;
                if(c === textProps.color) d.classList.add('active');
                d.onclick = () => setColor(c, d);
                grid.appendChild(d);
            });
        }

        async function initDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains(STORE_NAME)) d.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
                };
                req.onsuccess = (e) => { db = e.target.result; resolve(); };
                req.onerror = (e) => reject("DB Error");
            });
        }
        async function saveImageToDB(imgData) {
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).put(imgData); 
            return new Promise(resolve => tx.oncomplete = resolve);
        }
        async function getAllImages() {
            if(!db) return [];
            const tx = db.transaction(STORE_NAME, "readonly");
            const req = tx.objectStore(STORE_NAME).getAll();
            return new Promise(resolve => req.onsuccess = () => resolve(req.result));
        }
        async function clearDB() {
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).clear();
            return new Promise(resolve => tx.oncomplete = resolve);
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebar-overlay').classList.toggle('active'); }
        function toggleSettings() { document.getElementById('modal-overlay').classList.toggle('active'); }
        function closeSettings(e) { if(e.target.id==='modal-overlay') toggleSettings(); }
        
        function toggleToolsMinimize() {
            document.getElementById('ui-tools').classList.toggle('minimized');
        }

        function setMode(m) {
            const activeTA = document.querySelector('.live-textarea');
            if(activeTA) {
                activeTA.blur(); 
            }

            mode = m;
            document.getElementById('btn-edit').className = `pill-btn ${m==='edit'?'active':''}`;
            document.getElementById('btn-quiz').className = `pill-btn ${m==='quiz'?'active':''}`;
            
            const isEdit = (m === 'edit');
            document.getElementById('ui-history').style.display = isEdit ? 'flex' : 'none';
            document.getElementById('ui-tools').style.display = isEdit ? 'flex' : 'none';
            
            updateTextPropsVisibility(false);

            if(appData.idx > -1) {
                appData.images[appData.idx].bars.forEach(b => {
                    if(mode === 'quiz') {
                        if(b.type === 'box') b.hidden = true;
                        if(b.type === 'text') b.hidden = !!b.redactable; 
                    }
                });
            }
            draw();
        }

        function setTool(t) {
            activeTool = t;
            document.getElementById('btn-tool-box').className = `icon-btn ${t==='box'?'active':''}`;
            document.getElementById('btn-tool-text').className = `icon-btn ${t==='text'?'active':''}`;
            
            updateTextPropsVisibility(false);
        }
        
        function handleTextToolClick(e) {
            if(activeTool === 'text') {
                updateTextPropsVisibility(!isTextPropsOpen);
            } else {
                setTool('text');
                updateTextPropsVisibility(false); 
            }
        }
        
        function updateTextPropsVisibility(show) {
            isTextPropsOpen = show;
            document.getElementById('ui-text-props').style.display = (mode === 'edit' && activeTool === 'text' && isTextPropsOpen) ? 'flex' : 'none';
        }

        document.addEventListener('mousedown', (e) => {
            const propsPanel = document.getElementById('ui-text-props');
            const textBtn = document.getElementById('btn-tool-text');
            if(isTextPropsOpen && mode === 'edit') {
                if (!propsPanel.contains(e.target) && !textBtn.contains(e.target) && !e.target.closest('.live-textarea')) {
                     updateTextPropsVisibility(false);
                }
            }
        });

        function updateTextSize(val) { textProps.size = parseInt(val); document.getElementById('text-size-val').innerText = val; updateActiveTextBox(); }
        function updateFont(val) { textProps.font = val; updateActiveTextBox(); }
        function toggleStyle(s) { 
            textProps[s] = !textProps[s]; 
            document.getElementById(`btn-${s}`).classList.toggle('active', textProps[s]);
            updateActiveTextBox(); 
        }
        
        function toggleRedactable() {
            textProps.redactable = !textProps.redactable;
            const btn = document.getElementById('btn-redactable');
            btn.innerHTML = textProps.redactable ? 'üîí' : 'üîì';
            btn.classList.toggle('lock-btn', textProps.redactable);
            btn.classList.toggle('active', textProps.redactable);
            updateActiveTextBox();
        }

        function setColor(c, el) {
            textProps.color = c;
            document.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
            updateActiveTextBox();
        }

        function updateActiveTextBox() {
            if(activeTextIndex !== -1 && appData.idx !== -1) {
                const b = appData.images[appData.idx].bars[activeTextIndex];
                b.fontSize = textProps.size;
                b.fontFamily = textProps.font;
                b.bold = textProps.bold;
                b.italic = textProps.italic;
                b.underline = textProps.underline;
                b.color = textProps.color;
                b.redactable = textProps.redactable;

                const input = document.querySelector('.live-textarea');
                if(input) {
                    input.style.font = `${b.italic?'italic ':''} ${b.bold?'bold ':''} ${b.fontSize}px ${b.fontFamily}`;
                    input.style.color = b.color;
                    input.style.textDecoration = b.underline ? 'underline' : 'none';
                    if(input.autoResize) input.autoResize();
                }
                saveImageToDB(appData.images[appData.idx]);
                draw(); 
            }
        }

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const wrapper = document.getElementById('content-wrapper');

        function draw() {
            if(appData.idx === -1 || !appData.images[appData.idx]) return;
            const data = appData.images[appData.idx];
            const img = imgObjects[appData.idx];
            if(!img || img.width === 0) return;

            ctx.clearRect(0,0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            if(!data.bars) return;

            data.bars.forEach((b, i) => {
                if(i === activeTextIndex) return; 

                if(b.type === 'text') {
                    let isRedacted = false;
                    if(mode === 'quiz' && b.redactable && b.hidden) isRedacted = true;

                    if(isRedacted) {
                        ctx.fillStyle = "black";
                        ctx.fillRect(b.x, b.y, b.w, b.h);
                    } else {
                        const weight = b.bold ? 'bold ' : '';
                        const style = b.italic ? 'italic ' : '';
                        ctx.font = `${style}${weight}${b.fontSize}px ${b.fontFamily || 'sans-serif'}`;
                        ctx.textBaseline = 'top';
                        
                        ctx.strokeStyle = 'black'; ctx.lineWidth = 4;
                        ctx.strokeText(b.text, b.x, b.y);
                        
                        ctx.fillStyle = b.color || '#ffffff';
                        ctx.fillText(b.text, b.x, b.y);

                        if(b.underline) {
                            const m = ctx.measureText(b.text);
                            ctx.beginPath();
                            ctx.moveTo(b.x, b.y + b.fontSize);
                            ctx.lineTo(b.x + m.width, b.y + b.fontSize);
                            ctx.strokeStyle = b.color || '#ffffff';
                            ctx.lineWidth = Math.max(1, b.fontSize/12);
                            ctx.stroke();
                        }
                        
                        if(mode === 'edit' && b.redactable) {
                            ctx.font = '16px sans-serif';
                            ctx.fillStyle = '#ff3333';
                            ctx.fillText('üîí', b.x - 20, b.y);
                        }
                    }
                } 
                else {
                    if(mode === 'edit') {
                        ctx.fillStyle = "rgba(0, 0, 0, 0.3)";
                        ctx.fillRect(b.x, b.y, b.w, b.h);
                        ctx.strokeStyle = "rgba(255,255,255,0.8)";
                        ctx.lineWidth = 2;
                        ctx.strokeRect(b.x, b.y, b.w, b.h);
                    } else {
                        if(b.hidden) {
                            ctx.fillStyle = "black";
                            ctx.fillRect(b.x, b.y, b.w, b.h);
                        } else {
                            ctx.lineWidth = 3; ctx.strokeStyle = "white";
                            ctx.strokeRect(b.x, b.y, b.w, b.h);
                            ctx.fillStyle = "rgba(0,0,0,0.25)";
                            ctx.fillRect(b.x, b.y, b.w, b.h);
                        }
                    }
                }
            });
        }

        function activateTextInput(index) {
            if(appData.idx === -1) return;
            activeTextIndex = index;
            const b = appData.images[appData.idx].bars[index];
            
            textProps.size = b.fontSize;
            textProps.font = b.fontFamily;
            textProps.bold = b.bold;
            textProps.italic = b.italic;
            textProps.underline = b.underline;
            textProps.color = b.color;
            textProps.redactable = b.redactable || false;
            
            document.getElementById('text-size-slider').value = b.fontSize;
            document.getElementById('text-size-val').innerText = b.fontSize;
            document.getElementById('font-select').value = b.fontFamily;
            document.getElementById('btn-bold').classList.toggle('active', b.bold);
            document.getElementById('btn-italic').classList.toggle('active', b.italic);
            document.getElementById('btn-underline').classList.toggle('active', b.underline);
            
            const btnRedact = document.getElementById('btn-redactable');
            btnRedact.innerHTML = b.redactable ? 'üîí' : 'üîì';
            btnRedact.classList.toggle('lock-btn', b.redactable);
            btnRedact.classList.toggle('active', b.redactable);

            document.querySelectorAll('.swatch').forEach(s => {
                s.classList.toggle('active', s.style.backgroundColor === b.color || (b.color==='#ffffff' && s.style.backgroundColor==='rgb(255, 255, 255)'));
            });

            const input = document.createElement('textarea');
            input.className = 'live-textarea';
            input.value = b.text;
            input.style.left = b.x + 'px';
            input.style.top = b.y + 'px';
            input.style.font = `${b.italic?'italic ':''} ${b.bold?'bold ':''} ${b.fontSize}px ${b.fontFamily}`;
            input.style.color = b.color;
            input.style.textDecoration = b.underline ? 'underline' : 'none';
            input.style.width = Math.max(b.w, 50) + 'px';
            input.style.height = (b.h || b.fontSize*1.2) + 'px';

            wrapper.appendChild(input);
            input.focus();
            
            draw();

            const resize = () => {
                input.style.width='auto'; 
                input.style.height='auto';
                input.style.width = (input.scrollWidth + 10) + 'px'; 
                input.style.height = input.scrollHeight + 'px';
            };
            input.autoResize = resize;
            input.addEventListener('input', resize);
            resize(); 

            const commit = () => {
                const txt = input.value.trim();
                if(txt === "") {
                    appData.images[appData.idx].bars.splice(index, 1);
                } else {
                    b.text = input.value; 
                    
                    ctx.save();
                    const weight = b.bold ? 'bold ' : '';
                    const style = b.italic ? 'italic ' : '';
                    ctx.font = `${style}${weight}${b.fontSize}px ${b.fontFamily || 'sans-serif'}`;
                    ctx.textBaseline = 'top'; 

                    const lines = b.text.split('\n');
                    let maxW = 0;
                    lines.forEach(line => {
                        const m = ctx.measureText(line);
                        if(m.width > maxW) maxW = m.width;
                    });
                    
                    b.w = maxW + 10; 
                    b.h = lines.length * (b.fontSize * 1.2); 
                    ctx.restore();
                }
                saveImageToDB(appData.images[appData.idx]);
                if(input.parentNode) wrapper.removeChild(input);
                activeTextIndex = -1;
                draw();
            };
            input.addEventListener('blur', commit);
        }

        function getPointerPos(e) {
            let cx, cy;
            if (e.touches && e.touches.length > 0) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; } 
            else if (e.changedTouches) { cx = e.changedTouches[0].clientX; cy = e.changedTouches[0].clientY; }
            else { cx = e.clientX; cy = e.clientY; }
            const rect = canvas.getBoundingClientRect();
            return {
                screenX: cx, screenY: cy,
                canvasX: (cx - rect.left) / currentScale,
                canvasY: (cy - rect.top) / currentScale
            };
        }

        function handleStart(e) {
            if(activeTextIndex !== -1) return;
            if(appData.idx === -1) return;

            if (e.touches && e.touches.length === 2) {
                isPinching = true;
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                lastPinchDist = Math.hypot(dx, dy);
                pinchStartCenter = { x: (e.touches[0].clientX+e.touches[1].clientX)/2, y: (e.touches[0].clientY+e.touches[1].clientY)/2 };
                e.preventDefault(); return;
            }
            if (e.button === 1 || (e.button === 0 && e.shiftKey)) {
                isPanning = true; panStartX = e.clientX - panX; panStartY = e.clientY - panY;
                e.preventDefault(); return;
            }

            isPointerDown = true;
            const pos = getPointerPos(e);
            startX = pos.canvasX; startY = pos.canvasY;
            isDragAction = false;
        }

        function handleMove(e) {
            if(activeTextIndex !== -1) return;
            if(isPinching) {
                e.preventDefault();
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const dist = Math.hypot(dx, dy);
                if(Math.abs(dist - lastPinchDist) > 2) {
                    const f = 0.002 * (sliderValue / 150);
                    adjustZoom((dist - lastPinchDist) * f);
                    lastPinchDist = dist;
                }
                const cur = { x: (e.touches[0].clientX+e.touches[1].clientX)/2, y: (e.touches[0].clientY+e.touches[1].clientY)/2 };
                panX += cur.x - pinchStartCenter.x; panY += cur.y - pinchStartCenter.y;
                updateTransform(); pinchStartCenter = cur;
                return;
            }
            if(isPanning) {
                e.preventDefault();
                let cx = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                let cy = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                panX = cx - panStartX; panY = cy - panStartY;
                updateTransform(); return;
            }
            if(appData.idx === -1 || !isPointerDown) return;

            const pos = getPointerPos(e);
            if(Math.abs(pos.canvasX - startX) > 5 || Math.abs(pos.canvasY - startY) > 5) isDragAction = true;

            if(isDragAction && mode === 'edit') {
                if(e.cancelable) e.preventDefault();
                draw();
                ctx.fillStyle = "rgba(0, 0, 0, 0.25)"; 
                ctx.fillRect(startX, startY, pos.canvasX - startX, pos.canvasY - startY);
                ctx.strokeStyle = "white"; ctx.lineWidth = 1;
                ctx.strokeRect(startX, startY, pos.canvasX - startX, pos.canvasY - startY);
            }
        }

        function handleEnd(e) {
            if(activeTextIndex !== -1) return;
            isPointerDown = false;
            if(isPinching || isPanning) { isPinching=false; isPanning=false; return; }

            const pos = getPointerPos(e);

            if(isDragAction && mode === 'edit') {
                const w = Math.abs(pos.canvasX - startX);
                const h = Math.abs(pos.canvasY - startY);
                const finalX = Math.min(startX, pos.canvasX);
                const finalY = Math.min(startY, pos.canvasY);

                if(w > 5 && h > 5) {
                    pushHistory();
                    if(activeTool === 'box') {
                        appData.images[appData.idx].bars.push({
                            x: finalX, y: finalY, w: w, h: h, hidden: true, type: 'box'
                        });
                        saveImageToDB(appData.images[appData.idx]);
                    } else if(activeTool === 'text') {
                        const imgW = appData.images[appData.idx].width;
                        const dynamicSize = Math.max(30, Math.floor(imgW / 35));
                        textProps.size = dynamicSize;

                        appData.images[appData.idx].bars.push({
                            x: finalX, y: finalY, w: 10, h: textProps.size,
                            text: "",
                            fontSize: textProps.size, fontFamily: textProps.font,
                            bold: textProps.bold, italic: textProps.italic,
                            underline: textProps.underline, color: textProps.color,
                            redactable: textProps.redactable,
                            type: 'text', hidden: false
                        });
                        const newIdx = appData.images[appData.idx].bars.length - 1;
                        saveImageToDB(appData.images[appData.idx]);
                        activateTextInput(newIdx);
                    }
                }
                draw();
                isDragAction = false;
                return;
            }

            const bars = appData.images[appData.idx].bars;
            for(let i=bars.length-1; i>=0; i--) {
                let b = bars[i];
                if(pos.canvasX>=b.x && pos.canvasX<=b.x+b.w && pos.canvasY>=b.y && pos.canvasY<=b.y+b.h) {
                    if(mode === 'quiz') {
                        if(b.type === 'box' || !b.type) b.hidden = !b.hidden;
                        else if(b.type === 'text' && b.redactable) b.hidden = !b.hidden;
                        saveImageToDB(appData.images[appData.idx]);
                    } 
                    else if(mode === 'edit') {
                        if (b.type === 'text') {
                            if (activeTool === 'text') {
                                activateTextInput(i);
                            } else {
                                if(confirm("Delete text?")) {
                                    pushHistory();
                                    bars.splice(i, 1);
                                    saveImageToDB(appData.images[appData.idx]);
                                }
                            }
                        } else {
                            if(confirm("Delete box?")) {
                                pushHistory();
                                bars.splice(i, 1);
                                saveImageToDB(appData.images[appData.idx]);
                            }
                        }
                    }
                    if(e.cancelable) e.preventDefault();
                    break;
                }
            }
            draw();
        }

        function pushHistory() {
            if(appData.idx === -1) return;
            undoStack.push(JSON.parse(JSON.stringify(appData.images[appData.idx].bars)));
            redoStack = []; updateHistoryUI();
        }
        function undoAction() {
            if(undoStack.length===0)return;
            redoStack.push(JSON.parse(JSON.stringify(appData.images[appData.idx].bars)));
            appData.images[appData.idx].bars = undoStack.pop();
            saveImageToDB(appData.images[appData.idx]); draw(); updateHistoryUI();
        }
        function redoAction() {
            if(redoStack.length===0)return;
            undoStack.push(JSON.parse(JSON.stringify(appData.images[appData.idx].bars)));
            appData.images[appData.idx].bars = redoStack.pop();
            saveImageToDB(appData.images[appData.idx]); draw(); updateHistoryUI();
        }
        function updateHistoryUI() {
            document.getElementById('btn-undo').disabled = undoStack.length===0;
            document.getElementById('btn-redo').disabled = redoStack.length===0;
        }

        function adjustZoom(delta) {
            let s = currentScale + delta;
            if(s < 0.1) s = 0.1;
            currentScale = s;
            updateTransform();
            document.getElementById('zoom-disp').innerText = Math.round(s*100)+'%';
        }
        function updateZoomSpeed(v) { sliderValue=parseInt(v); document.getElementById('speed-val').innerText=v+'%'; }
        function updateTransform() { wrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${currentScale})`; }

        document.getElementById('main').addEventListener('wheel', (e) => {
            e.preventDefault();
            if(e.ctrlKey) {
                const f = 0.0045 * (sliderValue/100);
                adjustZoom(e.deltaY * -1 * f);
            } else {
                if(Math.abs(e.deltaX)<4 && Math.abs(e.deltaY)<4) return;
                panX -= e.deltaX; panY -= e.deltaY;
                updateTransform();
            }
        }, {passive:false});

        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('touchstart', handleStart, {passive:false});
        canvas.addEventListener('touchmove', handleMove, {passive:false});
        canvas.addEventListener('touchend', handleEnd, {passive:false});

        function renderGallery() {
            const g = document.getElementById('gallery-list'); g.innerHTML='';
            appData.images.forEach((img,i) => {
                const d=document.createElement('div'); d.className=`gallery-item ${i===appData.idx?'active':''}`;
                d.innerHTML=`<div style="display:flex;align-items:center;flex:1;overflow:hidden;" onclick="selectImage(${i})"><img src="${img.src}"><span>${img.name}</span></div><button class="rename-btn" onclick="renameImage(event,${i})">‚úé</button>`;
                g.appendChild(d);
            });
            document.getElementById('empty-state').style.display = appData.images.length?'none':'block';
            canvas.style.display = appData.images.length?'block':'none';
        }
        function selectImage(index) {
            appData.idx = index;
            document.querySelectorAll('.gallery-item').forEach((item, i) => item.classList.toggle('active', i === index));
            if(appData.images[index]) {
                canvas.width = appData.images[index].width;
                canvas.height = appData.images[index].height;
            }
            panX=0; panY=0; undoStack=[]; redoStack=[]; updateHistoryUI();
            fitToScreen(); setMode(mode); draw();
        }
        function fitToScreen() {
            if(appData.idx===-1 || !appData.images[appData.idx]) return;
            const img = appData.images[appData.idx];
            applyZoom(Math.min(window.innerWidth/img.width, window.innerHeight/img.height, 1) * 0.95);
        }
        function applyZoom(s) { currentScale=s; updateTransform(); document.getElementById('zoom-disp').innerText = Math.round(s*100)+'%'; }
        function renameImage(e, i) { e.stopPropagation(); const n=prompt("Rename:", appData.images[i].name); if(n){ appData.images[i].name=n.trim(); saveImageToDB(appData.images[i]); renderGallery(); } }

        function downloadData() {
            if(appData.images.length===0) return alert("No data");
            const a = document.createElement('a');
            const file = new Blob([JSON.stringify(appData.images)], {type: 'application/json'});
            a.href = URL.createObjectURL(file);
            a.download = `readact_backup_${Date.now()}.json`;
            a.click();
        }
        document.getElementById('fileLoader').addEventListener('change', (e) => {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = (evt) => {
                try {
                    const d = JSON.parse(evt.target.result);
                    if(Array.isArray(d)) {
                        appData.images = d;
                        clearDB().then(() => {
                            let p = [];
                            d.forEach(x => p.push(saveImageToDB(x)));
                            Promise.all(p)
                                .then(()=>location.reload())
                                .catch(e => alert("Error saving files: " + e));
                        });
                    }
                } catch(err) { alert("Invalid JSON"); }
            };
            r.readAsText(f);
        });
        document.getElementById('imgLoader').addEventListener('change', (e) => {
            if(!e.target.files.length) return;
            let loaded = 0;
            const total = e.target.files.length;
            Array.from(e.target.files).forEach(file => {
                const r = new FileReader();
                r.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => {
                        const newImgData = {
                            id: Date.now() + Math.random(),
                            name: file.name,
                            src: evt.target.result,
                            width: img.width, height: img.height,
                            bars: []
                        };
                        appData.images.push(newImgData);
                        imgObjects.push(img);
                        saveImageToDB(newImgData);
                        loaded++;
                        if(loaded === total) { renderGallery(); selectImage(appData.images.length-1); }
                    };
                    img.src = evt.target.result;
                };
                r.readAsDataURL(file);
            });
        });
        function resetAll() {
            if(confirm("Delete all data? This cannot be undone.")) {
                clearDB().then(()=>location.reload());
            }
        }
    </script>
</body>
</html>
